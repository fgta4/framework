/**
 * fgta-uibase-4.8.2.js
 * fungsi-fungsi dasar dari sebuah modul
 * seluruh mjs modul fungsi dengan pengenal export
 * akan diwarisi oleh semua modul
 *
 * Agung Nugroho <agung@ferrine.com> http://www.ferrine.com
 * Jakarta, 30 Agustus 2019
 *
 */

const uibase={maskshowing:!1,dlgmaskshowing:"none"},MASKS=[],fgta_output=$("#fgta_output"),fgta_output_content=$("#fgta_output_content"),fgta_output_error=$("#fgta_output_error");var PAGES,LastScroll=0;export var events={OnSizeRecalculated:new CustomEvent("OnSizeRecalculated",{detail:{}}),OnButtonBack:new CustomEvent("OnButtonBack",{detail:{cancel:!1}}),OnButtonHome:new CustomEvent("OnButtonHome",{detail:{cancel:!1}})};export async function ready(){$ui.resizing_ev=null,$(window).on("resize",(()=>{clearTimeout($ui.resizing_ev),$ui.resizing_ev=setTimeout($ui.iframe_resize,200)}));let e=$ui.iframe_resize();if($ui.OnSizeRecalculated(e.width,e.height),window.back=e=>{events.OnButtonBack.detail.cancel=!1,$ui.triggerevent(events.OnButtonBack,{}),e(events.OnButtonBack.detail.cancel)},window.home=e=>{events.OnButtonHome.detail.cancel=!1,$ui.triggerevent(events.OnButtonHome,{}),e(events.OnButtonHome.detail.cancel)},window.fgtaTimingPatch&&setTimeout($ui.iframe_resize,100),window.self!==window.top){console.log(`module ${window.global.modulefullname} ready`);var t=document.querySelector('meta[name="variancename"]').content,n=document.createElement("div");n.style.position="fixed",n.style.bottom="30px",n.style.right="30px",n.style.cursor="pointer",n.innerHTML="reload",n.addEventListener("click",(e=>{window.location.href+=`?variancename=${t}`})),document.getElementsByTagName("body")[0].appendChild(n)}}export async function init(){console.log("module initialization not created yet")}export function setPages(e){PAGES=e}export function getPages(){return PAGES}export function getTimestamp(){var e=new Date;return Math.floor(e.getTime()/1e3)}export function mask(e,t=null){null==t&&(t=getTimestamp());var n=document.getElementsByTagName("body")[0];window.self!==window.top&&(n=window.parent.document.getElementsByTagName("body")[0]);var a=document.createElement("div");if(a.id=`__fgta-mask-${t}__`,a.code=t,a.classList.add("fgta_mask"),null!=e){var i=document.createElement("div");i.innerHTML=e,i.classList.add("fgta_mask_message"),a.appendChild(i)}return n.appendChild(a),MASKS.push(a),a.focus(),a}export function unmask(e=null,t){var n=null;if(null!=e&&e.hasOwnProperty("code")&&(n=e.code),null==n){if(MASKS.length>0){MASKS.pop().remove()}}else{var a=null,i=`__fgta-mask-${n}__`;for(let e of MASKS)e.id==i&&(a=MASKS.indexOf(e),e.remove());null!=a&&MASKS.splice(a,1)}"function"==typeof t&&t()}export async function ShowMessage(e,t,n){let a=getTimestamp()+"-message";return new Promise((async i=>{var o=null,r=e;"[ERROR]"===e.substring(0,7)?(r=e.replace("[ERROR]",""),o="icon-dialog-error.svg"):"[WARNING]"===e.substring(0,9)?(r=e.replace("[WARNING]",""),o="icon-dialog-warning.svg"):"[QUESTION]"===e.substring(0,10)?(r=e.replace("[QUESTION]",""),o="icon-dialog-question.svg"):"[INFO]"===e.substring(0,6)&&(r=e.replace("[INFO]",""),o="icon-dialog-info.svg"),e=r;var s=mask(null,a),l=document.createElement("div");l.classList.add("fgta_mask_dialogcontainer");var c=document.createElement("div");c.classList.add("fgta_mask_dialogup"),c.innerHTML=null==o?e:`\n\t\t\t\t<div>\n\t\t\t\t\t<img src="index.php/public/images/${o}" style="width:32px; height:32px">\n\t\t\t\t</div>\n\t\t\t\t<div style="margin-left: 10px">\n\t\t\t\t\t${e}\n\t\t\t\t</div>\n\t\t\t`;var d,u=document.createElement("div");for(var p in u.classList.add("fgta_mask_dialogdw"),null==t&&(t={Ok:async()=>{}}),t){let e=t[p],n=document.createElement("a");n.innerHTML=p,n.classList.add("c8"),n.classList.add("fgta_mask_dialogbtn"),$(n).linkbutton({}),n.addEventListener("click",(async t=>{"function"==typeof e&&(t.layercode=a,await e(t),t.stopPropagation(),unmask(a),i())})),u.appendChild(n),d=n}l.appendChild(c),l.appendChild(u),s.appendChild(l),null!=d&&d.focus(),"function"==typeof n&&await n()}))}async function readfile(e){return new Promise(((t,n)=>{var a=new FileReader;a.onload=function(a){if(2==a.target.readyState){a.target.error&&n("Error while reading file");var i=a.target.result,o={name:e.name,size:e.size,type:e.type,data:i};if(e.type.startsWith("image")){var r=new Image;r.src=a.target.result,r.onload=function(){o.width=this.width,o.height=this.height,t(o)}}else t(o)}},a.readAsDataURL(e)}))}export async function getNonce(e){let t=`index.php/get/fgta/framework/otp/getnonce/${e}/getnonce`;try{var n=await(async e=>new Promise((function(t,n){let a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==a.readyState)try{if(200!=a.status)throw Error(hr.statusText);t(a.response)}catch(e){n(e)}},a.open("GET",e,!0),a.setRequestHeader("cache-control","no-cache, must-revalidate, post-check=0, pre-check=0"),a.setRequestHeader("cache-control","max-age=0"),a.setRequestHeader("expires","0"),a.setRequestHeader("pragma","no-cache");var i=[];for(var o in i["fgta-appid"]="appid",i["fgta-secret"]="secret",i["fgta-tokenid"]=Cookies.get("tokenid"),i["fgta-mode"]="api","function"==typeof $ui.setApiHeaders&&$ui.setApiHeaders(i),i)a.setRequestHeader(o,i[o]);a.send()})))(t),a=JSON.parse(n);if(0==a.code)return a.responseData.nonce;throw Error("Error on getNonce. "+a.message)}catch(e){throw e}}export async function download(e,t,n){console.log(e),console.log(t);let a={};for(let e in t){if("files"==e)throw Error("cannot use 'files' as main parameter name");a[e]=t[e]}var i={txid:null,requestParam:a};let o=`index.php/download/${e}`;try{fgta_output_content.html(""),fgta_output_error.html("");try{var r=await getNonce(e),s=await(async(e,t,n)=>new Promise((function(a,i){let o=new XMLHttpRequest;o.onload=function(){try{if(200!=o.status)throw Error(o.statusText);var e=o.getResponseHeader("content-type"),t=o.getResponseHeader("content-disposition"),n=/filename="(.+?)"/gi.exec(t),r=null!=n&&n[1]?n[1]:"filename";if(null==n)throw Error(o.responseText);a({filename:r,contenttype:e,data:o.response})}catch(e){i(e)}},o.open("POST",e,!0),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("cache-control","no-cache, must-revalidate, post-check=0, pre-check=0"),o.setRequestHeader("cache-control","max-age=0"),o.setRequestHeader("expires","0"),o.setRequestHeader("expires","Tue, 01 Jan 1980 1:00:00 GMT"),o.setRequestHeader("pragma","no-cache"),o.setRequestHeader("fgta-appid","appid"),o.setRequestHeader("fgta-secret","secret"),o.setRequestHeader("fgta-nonce",n),o.setRequestHeader("fgta-tokenid",Cookies.get("tokenid"));var r=JSON.stringify(t);o.send(r)})))(o,i,r),l="";if("function"==typeof n)n(s);else{var c=document.createElement("A");c.href=s.data,c.download=s.filename,document.body.appendChild(c),c.click(),document.body.removeChild(c)}}catch(e){if(n(null,e,t),!(null!=t&&t.handled))throw fgta_output_content.html(l),fgta_output_error.html(e.message),e}}catch(e){throw e}}export async function apicall(e,t,n){let a={};for(let e in t){if("files"==e)throw Error("cannot use 'files' as main parameter name");a[e]=t[e]}var i={};for(var o in n)if(void 0!==n[o]){var r=n[o],s=await readfile(r);i[o]=s}a.files=i;var l={txid:null,requestParam:a};let c=`index.php/api/${e}`;try{fgta_output_content.html(""),fgta_output_error.html("");try{var d={},u=await getNonce(e),p=await(async(e,t,n)=>new Promise((function(a,i){let o=new XMLHttpRequest;o.onreadystatechange=function(){if(4==o.readyState)try{if(200!=o.status)throw Error(o.statusText);a(o.response)}catch(e){i(e)}},o.open("POST",e,!0),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("cache-control","no-cache, must-revalidate, post-check=0, pre-check=0"),o.setRequestHeader("cache-control","max-age=0"),o.setRequestHeader("expires","0"),o.setRequestHeader("expires","Tue, 01 Jan 1980 1:00:00 GMT"),o.setRequestHeader("pragma","no-cache");var r=[];for(var s in r["fgta-appid"]="appid",r["fgta-secret"]="secret",r["fgta-nonce"]=n,r["fgta-tokenid"]=Cookies.get("tokenid"),"function"==typeof $ui.setApiHeaders&&$ui.setApiHeaders(r),r)o.setRequestHeader(s,r[s]);var l=JSON.stringify(t);o.send(l)})))(c,l,u),g="";try{d=JSON.parse(p)}catch(e){throw g=p,e}if(null==d.contentoutput&&null==d.contentoutput||(g=d.contentoutput),0!==d.code){g+="<div>Error Code: "+d.code+"</div>";var m=Error(d.message);throw null!=d.trace&&console.error(d.trace),m}return d.responseData}catch(e){throw e.contentoutput=g,e}}catch(e){throw e}}export function triggerevent(e,t){return Object.assign(e.detail,t),document.dispatchEvent(e)}export function home(){null!=parent&&null!=parent.$ui&&"function"==typeof parent.$ui.OpenHomeMenu&&parent.$ui.OpenHomeMenu()}export async function exitconfirm(e){return new Promise(((t,n)=>{$.messager.confirm("Exit",e,(e=>{t(!!e)}))}))}export function iframe_resize(){let e=get_content_size(document.body);return triggerevent(events.OnSizeRecalculated,{width:e.width,height:e.height}),e}export function get_content_size(e){let t=e.currentStyle||window.getComputedStyle(e),n=parseInt(t.marginTop),a=parseInt(t.marginBottom),i=parseInt(t.marginLeft),o=parseInt(t.marginRight),r=parseInt(t.paddingTop),s=(parseInt(t.paddingBottom),parseInt(t.paddingLeft)),l=parseInt(t.paddingRight);return{width:window.innerWidth-i-o-s-l,height:window.innerHeight-n-a-r-l}}export function OnSizeRecalculated(e,t){}export function redirecttologinpage(){null!=parent?parent.location.reload():location.reload()}export function IsMessageShowing(){return"none"!=uibase.dlgmaskshowing}export function __ShowMessage(e,t,n){$(window).scrollTop();let a=document.createElement("div"),i=document.createElement("div"),o=document.createElement("div"),r=document.createElement("div"),s=document.createElement("div");a.id="__dialogmessage-mask__",i.id="__dialogmessage-waitmask__",r.id="__dialogmessage-waiting__",Object.assign(a.style,{position:"fixed",overflowY:"scroll",top:"0px",left:"0px",width:"calc(100vw - (100vw - 100%))",height:"100vh",overflow:"hidden",display:"table",backgroundColor:"black",opacity:0,zIndex:8998}),Object.assign(i.style,{position:"fixed",overflowY:"scroll",top:"0px",left:"0px",width:"calc(100vw - (100vw - 100%))",height:"100vh",overflow:"hidden",display:"flex",justifyContent:"center",alignItems:"center",zIndex:8999}),Object.assign(o.style,{}),Object.assign(r.style,{margin:"auto",textAlign:"center",backgroundColor:"#ffffff",color:"#000000",width:"50vh",height:"100px",padding:"10px 10px 10px 10px",display:"flex",justifyContent:"center",alignItems:"center"}),void 0===t&&(t={OK:()=>{}});var l=[];for(var c in t){var d=t[c],u=c;let e=document.createElement("a");e.innerHTML=u,e.classList.add("c8"),Object.assign(e.style,{width:"60px",height:"30px",display:"flex",justifyContent:"center",alignItems:"center",marginLeft:"3px",marginRight:"3px",marginBottom:"20px"}),$(e).linkbutton({}),e.click_handler=d,e.button_click=()=>{"none"!=uibase.dlgmaskshowing&&("function"==typeof d&&e.click_handler(),null!=a.parentNode&&a.parentNode.removeChild(a),null!=i.parentNode&&i.parentNode.removeChild(i),uibase.dlgmaskshowing="none")},e.addEventListener("click",(t=>{e.button_click(),t.stopPropagation()})),s.appendChild(e),l.push(e)}var p=e=>{"Enter"==e.key&&(document.removeEventListener("keyup",p),l[0].button_click(),e.stopPropagation())};if(Object.assign(s.style,{height:"40px",backgroundColor:"#ffffff",color:"#000000",display:"flex",justifyContent:"center",alignItems:"center"}),"[ERROR]"===e.substring(0,7)){var g=e.replace("[ERROR]","");e=`<div><div style="display: flex; justify-content: center"><div style="width:32px; height:32px; background: url('images/messager_icons.png') 64px 0;"></div></div><div style="color:red; margin-top: 10px">${g}</div></div>`}else if("[WARNING]"===e.substring(0,9)){g=e.replace("[WARNING]","");e=`<div><div style="display: flex; justify-content: center"><div style="width:32px; height:32px; background: url('images/messager_icons.png') 32px 0;"></div></div><div style="margin-top: 10px">${g}</div></div>`}else if("[QUESTION]"===e.substring(0,10)){g=e.replace("[QUESTION]","");e=`<div><div style="display: flex; justify-content: center"><div style="width:32px; height:32px; background: url('images/messager_icons.png') 96px 0;"></div></div><div style="margin-top: 10px">${g}</div></div>`}else if("[INFO]"===e.substring(0,6)){g=e.replace("[INFO]","");e=`<div><div style="display: flex; justify-content: center"><div style="width:32px; height:32px; background: url('images/messager_icons.png') 0 0;"></div></div><div style="margin-top: 10px">${g}</div></div>`}if(uibase.dlgmaskshowing="showing",null!==document.getElementById("__dialogmessage-waitmask__")){document.getElementById("__dialogmessage-waiting__").innerHTML=e}else{let t=0;a.style.opacity=0,r.innerHTML=e,o.appendChild(r),o.appendChild(s),i.appendChild(o),document.body.appendChild(a),document.body.appendChild(i),$.parser.parse("#__dialogmessage-waiting__"),"function"==typeof n&&n();let l=setInterval((()=>{t<7?(t+=1,a.style.opacity=t/10):(document.addEventListener("keyup",p),uibase.dlgmaskshowing="showed",clearInterval(l))}),20)}}export async function fgta_longrun(e){if(null!==e.process_cookie&&void 0!==e.process_cookie)if(null!==e.api_url_start&&void 0!==e.api_url_start)if(null!==e.api_url_status&&void 0!==e.api_url_status){var t=e.process_cookie,n=e.api_url_start,a=e.api_url_status,i="function"==typeof e.onStarting?e.onStarting:()=>{},o="function"==typeof e.onError?e.onError:()=>{},r="function"==typeof e.onProgress?e.onProgress:()=>{},s="function"==typeof e.onFinished?e.onFinished:()=>{},l="function"==typeof e.onTick?e.onTick:()=>{},c=t,d={options:{process_id:Cookies.get(c),data:e.data}},u=n;try{var p=await $ui.apicall(u,d);if(void 0===p.respond)throw{errormessage:"Tidak ada respond dari microsevice"};if(d.options.process_id=p.process_id,!0===p.respond.started){Cookies.set(c,p.process_id),i(p);var g=setInterval((async()=>{var e=a;try{var t=await $ui.apicall(e,d);if(l(t),void 0===t.respond)throw Cookies.remove(c),clearInterval(g),{errormessage:"Tidak ada respond dari microsevice"};var n=t.respond,i=n.finished||!1===n.started,u=n.error,p=n.errormessage;if(u)throw Cookies.remove(c),clearInterval(g),{errormessage:p};!0===i?(Cookies.remove(c),clearInterval(g),setTimeout((()=>{s(n)}),1e3)):r(n)}catch(e){clearInterval(g),Cookies.remove(c),o(e),!0!==e.suppresserror&&$ui.ShowMessage("[ERROR]"+e.errormessage)}}),1e3)}}catch(e){Cookies.remove(c),o(e),!0!==e.suppresserror&&$ui.ShowMessage("[ERROR]"+e.errormessage)}}else $ui.ShowMessage("api_url_status belum didefinisikan");else $ui.ShowMessage("api_url_start belum didefinisikan");else $ui.ShowMessage("process_cookie belum didefinisikan")}export function KeepScroll(){LastScroll=$(window).scrollTop()}export function ResumeScroll(e){setTimeout((()=>{$(window).scrollTop(LastScroll),"function"==typeof e&&e()}),300)}